<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Notifications - Smart Parking</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: white;
        min-height: 100vh;
        padding: 20px;
      }

      .notifications-container {
        max-width: 900px;
        margin: 40px auto;
      }

      /* HEADER */
      .page-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 20px;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .back-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: rgb(249, 249, 249);
        text-decoration: none;
        font-weight: 600;
        padding: 12px 20px;
        background: #1a1f71;
        border-radius: 10px;
        transition: all 0.3s;
      }

      .back-link:hover {
        background: #272da9;
      }

      .page-title {
        color: #1a1f71;
        font-size: 32px;
        font-weight: 700;
      }

      .mark-all-btn {
        padding: 12px 20px;
        background: #1a1f71;
        color: #ffffff;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .mark-all-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(15, 16, 117, 0.2);
      }

      /* FILTER TABS */
      .filter-tabs {
        background: white;
        border-radius: 15px;
        padding: 10px;
        margin-bottom: 25px;
        display: flex;
        gap: 10px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .tab-btn {
        flex: 1;
        padding: 12px 20px;
        background: none;
        border: none;
        color: #666;
        font-weight: 600;
        cursor: pointer;
        border-radius: 10px;
        transition: all 0.3s;
        font-size: 14px;
      }

      .tab-btn.active {
        background: #1a1f71;
        color: white;
      }

      /* NOTIFICATIONS LIST */
      .notifications-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .notification-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        transition: all 0.3s;
        cursor: pointer;
        border-left: 4px solid transparent;
      }

      .notification-card:hover {
        transform: translateX(5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .notification-card.unread {
        background: #f8f9ff;
        border-left-color: #091b6b;
      }

      .notification-header {
        display: flex;
        align-items: start;
        gap: 15px;
        margin-bottom: 12px;
      }

      .notification-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        flex-shrink: 0;
      }

      .icon-approved {
        background: #e8f5e9;
      }
      .icon-warning {
        background: #fff3e0;
      }
      .icon-expired {
        background: #ffebee;
      }
      .icon-reminder {
        background: #e3f2fd;
      }

      .notification-content {
        flex: 1;
      }

      .notification-title {
        font-size: 16px;
        font-weight: 700;
        color: #1a1f71;
        margin-bottom: 6px;
      }

      .notification-message {
        font-size: 14px;
        color: #666;
        line-height: 1.5;
        margin-bottom: 8px;
      }

      .notification-meta {
        display: flex;
        align-items: center;
        gap: 15px;
        font-size: 12px;
        color: #999;
      }

      .notification-time {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .notification-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
      }

      .badge-approved {
        background: #e8f5e9;
        color: #27ae60;
      }

      .badge-warning {
        background: #fff3e0;
        color: #ff9800;
      }

      .badge-expired {
        background: #ffebee;
        color: #f44336;
      }

      .unread-indicator {
        width: 10px;
        height: 10px;
        background: #667eea;
        border-radius: 50%;
        flex-shrink: 0;
      }

      /* EMPTY STATE */
      .empty-state {
        background: white;
        border-radius: 15px;
        padding: 60px 40px;
        text-align: center;
        box-shadow: 0 5px 20px rgba(39, 14, 161, 0.1);
      }

      .empty-icon {
        font-size: 64px;
        margin-bottom: 20px;
      }

      .empty-title {
        font-size: 20px;
        font-weight: 700;
        color: #1a1f71;
        margin-bottom: 10px;
      }

      .empty-text {
        color: #666;
        font-size: 14px;
      }

      /* RESPONSIVE */
      @media (max-width: 768px) {
        .notifications-container {
          padding: 0;
        }

        .page-title {
          font-size: 24px;
        }

        .filter-tabs {
          overflow-x: auto;
          flex-wrap: nowrap;
        }

        .tab-btn {
          white-space: nowrap;
        }
      }
    </style>
  </head>
  <body>
    <div class="notifications-container">
      <!-- HEADER -->
      <div class="page-header">
        <div class="header-left">
          <a href="#" class="back-link" onclick="goBack()">‚Üê Back</a>
          <h1 class="page-title">Notifications</h1>
        </div>
        <button class="mark-all-btn" onclick="markAllAsRead()">
          Mark All as Read
        </button>
      </div>

      <!-- FILTER TABS -->
      <div class="filter-tabs">
        <button class="tab-btn active" onclick="filterNotifications('all')">
          All
        </button>
        <button class="tab-btn" onclick="filterNotifications('approved')">
          Approved
        </button>
        <button class="tab-btn" onclick="filterNotifications('warnings')">
          Warnings
        </button>
        <button class="tab-btn" onclick="filterNotifications('reminders')">
          Reminders
        </button>
      </div>

      <!-- NOTIFICATIONS LIST -->
      <div class="notifications-list" id="notificationsList">
        <!-- Notifications will be loaded here -->
      </div>
    </div>

    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script>
      let notifications = [];
      let notificationPermission = "default";

      document.addEventListener("DOMContentLoaded", function () {
        if (!checkAuth("driver")) {
          return;
        }
        checkNotificationPermission();
        loadNotifications();
        startNotificationMonitoring();
        setInterval(loadNotifications, 30000);
      });

      function checkNotificationPermission() {
        if ("Notification" in window) {
          notificationPermission = Notification.permission;
        }
      }

      function requestNotificationPermission() {
        if ("Notification" in window) {
          Notification.requestPermission().then((permission) => {
            notificationPermission = permission;
            if (permission === "granted") {
              console.log("Notifications enabled");
            }
          });
        } else {
          alert("Your browser does not support notifications");
        }
      }

      async function loadNotifications() {
        const driverId = localStorage.getItem("driver_id");
        if (!driverId) {
          notifications = [];
          displayNotifications();
          return;
        }

        try {
          const response = await fetch(
            `${API_BASE_URL}/notification/driver/${driverId}`
          );
          const data = await response.json();

          if (data.success && data.notifications) {
            notifications = data.notifications.map((notif) => {
              const typeMap = {
                booking_approved: {
                  icon: "‚úÖ",
                  iconClass: "icon-approved",
                  badge: "Approved",
                  badgeClass: "badge-approved",
                },
                booking_cancelled: {
                  icon: "‚ùå",
                  iconClass: "icon-cancelled",
                  badge: "Cancelled",
                  badgeClass: "badge-cancelled",
                },
                payment_confirmed: {
                  icon: "üí≥",
                  iconClass: "icon-payment",
                  badge: "Payment",
                  badgeClass: "badge-approved",
                },
                payment_failed: {
                  icon: "‚ö†Ô∏è",
                  iconClass: "icon-warning",
                  badge: "Failed",
                  badgeClass: "badge-warning",
                },
                reminder: {
                  icon: "‚è∞",
                  iconClass: "icon-reminder",
                  badge: "Reminder",
                  badgeClass: "badge-approved",
                },
                warning: {
                  icon: "‚ö†Ô∏è",
                  iconClass: "icon-warning",
                  badge: "Warning",
                  badgeClass: "badge-warning",
                },
                checkout: {
                  icon: "‚úÖ",
                  iconClass: "icon-approved",
                  badge: "Completed",
                  badgeClass: "badge-approved",
                },
              };

              const typeInfo = typeMap[notif.type] || {
                icon: "üì¢",
                iconClass: "icon-info",
                badge: "Info",
                badgeClass: "badge-info",
              };
              const createdDate = new Date(notif.created_at);
              const timeAgo = getTimeAgo(createdDate);

              return {
                id: notif.notification_id,
                type: notif.type,
                icon: typeInfo.icon,
                iconClass: typeInfo.iconClass,
                title: notif.title,
                message: notif.message,
                badge: typeInfo.badge,
                badgeClass: typeInfo.badgeClass,
                time: timeAgo,
                timestamp: createdDate.getTime(),
                unread: !notif.is_read,
                bookingCode: notif.reservation_id
                  ? `RES-${notif.reservation_id}`
                  : null,
              };
            });
          } else {
            notifications = [];
          }

          displayNotifications();
          updateUnreadCount();
        } catch (error) {
          console.error("Error loading notifications:", error);
          notifications = [];
          displayNotifications();
        }
      }

      function getTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return "Just now";
        if (diffMins < 60)
          return `${diffMins} minute${diffMins > 1 ? "s" : ""} ago`;
        if (diffHours < 24)
          return `${diffHours} hour${diffHours > 1 ? "s" : ""} ago`;
        return `${diffDays} day${diffDays > 1 ? "s" : ""} ago`;
      }

      async function updateUnreadCount() {
        const driverId = localStorage.getItem("driver_id");
        if (!driverId) return;

        try {
          const response = await fetch(
            `${API_BASE_URL}/notification/unread-count/${driverId}`
          );
          const data = await response.json();

          if (data.success) {
            const badge = document.querySelector(".notification-badge");
            if (badge) {
              if (data.count > 0) {
                badge.textContent = data.count > 99 ? "99+" : data.count;
                badge.style.display = "block";
              } else {
                badge.style.display = "none";
              }
            }
          }
        } catch (error) {
          console.error("Error updating unread count:", error);
        }
      }

      function displayNotifications(filter = "all") {
        const container = document.getElementById("notificationsList");

        let filtered = notifications;
        if (filter !== "all") {
          const typeMap = {
            approved: "approved",
            warnings: "warning",
            reminders: "reminder",
          };
          filtered = notifications.filter((n) => n.type === typeMap[filter]);
        }

        if (filtered.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üîî</div>
                        <div class="empty-title">No Notifications</div>
                        <div class="empty-text">You're all caught up! Check back later for updates.</div>
                    </div>
                `;
          return;
        }

        container.innerHTML = filtered
          .map(
            (notif) => `
                <div class="notification-card ${
                  notif.unread ? "unread" : ""
                }" onclick="markAsRead('${notif.id}')">
                    <div class="notification-header">
                        <div class="notification-icon ${notif.iconClass}">${
              notif.icon
            }</div>
                        <div class="notification-content">
                            <div class="notification-title">${notif.title}</div>
                            <div class="notification-message">${
                              notif.message
                            }</div>
                            <div class="notification-meta">
                                <span class="notification-time">üïí ${
                                  notif.time
                                }</span>
                                <span class="notification-badge ${
                                  notif.badgeClass
                                }">${notif.badge}</span>
                                ${
                                  notif.unread
                                    ? '<span class="unread-indicator"></span>'
                                    : ""
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `
          )
          .join("");
      }

      function filterNotifications(filter) {
        // Update active tab
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        event.target.classList.add("active");

        displayNotifications(filter);
      }

      async function markAsRead(id) {
        const driverId = localStorage.getItem("driver_id");
        if (!driverId) return;

        const notif = notifications.find((n) => n.id == id);
        if (notif && notif.unread) {
          try {
            const response = await fetch(
              `${API_BASE_URL}/notification/read/${id}`,
              {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ driver_id: parseInt(driverId) }),
              }
            );

            const data = await response.json();
            if (data.success) {
              notif.unread = false;
              displayNotifications();
              updateUnreadCount();
            }
          } catch (error) {
            console.error("Error marking notification as read:", error);
            notif.unread = false;
            displayNotifications();
          }
        }
      }

      async function markAllAsRead() {
        const driverId = localStorage.getItem("driver_id");
        if (!driverId) return;

        try {
          const response = await fetch(
            `${API_BASE_URL}/notification/read-all/${driverId}`,
            {
              method: "PUT",
            }
          );

          const data = await response.json();
          if (data.success) {
            notifications.forEach((n) => (n.unread = false));
            displayNotifications();
            updateUnreadCount();
          }
        } catch (error) {
          console.error("Error marking all as read:", error);
          notifications.forEach((n) => (n.unread = false));
          displayNotifications();
        }
      }

      function startNotificationMonitoring() {
        // Check bookings every 30 seconds for time-based notifications
        setInterval(() => {
          checkBookingTimes();
        }, 30000); // Check every 30 seconds
      }

      function checkBookingTimes() {
        const bookings = JSON.parse(
          localStorage.getItem("parkingBookings") || "[]"
        );
        const now = new Date();

        bookings.forEach((booking) => {
          // Parse booking date and time
          const bookingDateTime = parseBookingDateTime(
            booking.date,
            booking.time
          );

          if (!bookingDateTime) return;

          // Calculate time differences
          const timeUntilStart = bookingDateTime.getTime() - now.getTime();
          const minutesUntilStart = Math.floor(timeUntilStart / 60000);

          // Arrival time reminder (30 minutes before)
          if (
            minutesUntilStart > 0 &&
            minutesUntilStart <= 30 &&
            minutesUntilStart >= 29
          ) {
            // Popup removed - notifications are shown in the list only

            // Add to notifications list
            addNotification({
              type: "reminder",
              icon: "‚è∞",
              iconClass: "icon-reminder",
              title: "Parking Time Approaching",
              message: `Your parking at ${booking.location} starts in ${minutesUntilStart} minutes.`,
              badge: "Reminder",
              badgeClass: "badge-approved",
            });
          }

          // Late arrival warning (if past arrival time by more than 15 minutes)
          if (minutesUntilStart < -15 && minutesUntilStart > -30) {
            // Popup removed - notifications are shown in the list only
          }

          // Parse duration and check expiry
          const duration = parseDuration(booking.duration);
          if (duration) {
            const expiryTime = new Date(
              bookingDateTime.getTime() + duration * 60 * 60 * 1000
            );
            const timeUntilExpiry = expiryTime.getTime() - now.getTime();
            const minutesUntilExpiry = Math.floor(timeUntilExpiry / 60000);

            // Expiring soon warning (15 minutes before)
            if (
              minutesUntilExpiry > 0 &&
              minutesUntilExpiry <= 15 &&
              minutesUntilExpiry >= 14
            ) {
              // Popup removed - notifications are shown in the list only

              addNotification({
                type: "warning",
                icon: "‚ö†Ô∏è",
                iconClass: "icon-warning",
                title: "Parking Time Ending Soon",
                message: `Your parking at ${booking.location} expires in ${minutesUntilExpiry} minutes.`,
                badge: "Warning",
                badgeClass: "badge-warning",
              });
            }

            // Expired notification
            if (minutesUntilExpiry < 0 && minutesUntilExpiry > -5) {
              // Popup removed - notifications are shown in the list only

              addNotification({
                type: "expired",
                icon: "üî¥",
                iconClass: "icon-expired",
                title: "Parking Time Expired",
                message: `Your parking at ${booking.location} has expired.`,
                badge: "Expired",
                badgeClass: "badge-expired",
              });
            }
          }
        });
      }

      function parseBookingDateTime(dateStr, timeStr) {
        try {
          // Parse date like "Nov 25, 2025"
          const dateParts = dateStr.match(/(\w+) (\d+), (\d+)/);
          if (!dateParts) return null;

          const monthMap = {
            Jan: 0,
            Feb: 1,
            Mar: 2,
            Apr: 3,
            May: 4,
            Jun: 5,
            Jul: 6,
            Aug: 7,
            Sep: 8,
            Oct: 9,
            Nov: 10,
            Dec: 11,
          };

          const month = monthMap[dateParts[1]];
          const day = parseInt(dateParts[2]);
          const year = parseInt(dateParts[3]);

          // Parse time like "10:00 AM"
          const timeParts = timeStr.match(/(\d+):(\d+) (AM|PM)/);
          if (!timeParts) return null;

          let hours = parseInt(timeParts[1]);
          const minutes = parseInt(timeParts[2]);
          const period = timeParts[3];

          if (period === "PM" && hours !== 12) hours += 12;
          if (period === "AM" && hours === 12) hours = 0;

          return new Date(year, month, day, hours, minutes);
        } catch (e) {
          return null;
        }
      }

      function parseDuration(durationStr) {
        // Parse "4 Hours" or "4 Hour"
        const match = durationStr.match(/(\d+)/);
        return match ? parseInt(match[1]) : null;
      }

      function addNotification(notifData) {
        const newNotif = {
          id: `notif-${Date.now()}`,
          time: "Just now",
          timestamp: new Date().getTime(),
          unread: true,
          ...notifData,
        };

        // Check if similar notification already exists
        const exists = notifications.some(
          (n) =>
            n.title === newNotif.title &&
            n.message === newNotif.message &&
            new Date().getTime() - n.timestamp < 60000 // Within last minute
        );

        if (!exists) {
          notifications.unshift(newNotif);
          displayNotifications();
        }
      }

      function goBack() {
        window.history.back();
      }
    </script>
  </body>
</html>
