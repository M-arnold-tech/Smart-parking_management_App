<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <title>Book Parking - Smart Parking</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: white;
            min-height: 100vh;
            
        }

         header {
            background-color: rgb(26, 37, 163);;
            padding: 20px 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            color: white;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .menu-icon {
            width: 40px;
            height: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
        }

        .menu-icon span {
            width: 100%;
            height: 3px;
            background-color: #1a1f71;
            border-radius: 2px;
        }
        .notification_btn {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }
        .notification_btn i {
            margin-left: 8px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background-color: #1a1f71;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            font-weight: bold;
        }

        .logo-text h1 {
            color: #ffffff;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 1px;
        }

       

        nav ul {
            display: flex;
            list-style: none;
            gap: 40px;
        }

        nav a {
            text-decoration: none;
            color: white;
            font-weight: 600;
            font-size: 16px;
            transition: color 0.3s;
        }

        nav a:hover {
            color: #c0ef05;
        }

        .user-icon {
            width: 50px;
            height: 50px;
            background-color: #c6c7dd;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .user-icon::before {
            content: "üë§";
            font-size: 24px;
            color: white;
        }
        .notification-container {
            position: relative;
            margin-right: 20px;
            cursor: pointer;
            font-size: 28px;
        }


        /* MAIN CONTAINER */
        .booking-container {
            max-width: 1100px;
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 30px;
            margin: 40px auto;
        }

        /* LEFT SECTION - BOOKING FORM */
        .booking-section {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            margin-bottom: 20px;
            transition: gap 0.3s;
        }

        .back-link:hover {
            gap: 12px;
        }

        .section-title {
            font-size: 28px;
            font-weight: 700;
            color: #1a1f71;
            margin-bottom: 10px;
        }

        .section-subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        /* LOCATION CARD */
        .location-card {
            background:#1a1f71;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            color: white;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .location-icon {
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            flex-shrink: 0;
        }

        .location-details h3 {
            font-size: 20px;
            margin-bottom: 6px;
        }

        .location-details p {
            opacity: 0.9;
            font-size: 14px;
        }

        .location-details .availability {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-top: 8px;
        }

        /* BOOKING FORM */
        .booking-form {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .form-section-title {
            font-size: 18px;
            font-weight: 700;
            color: #1a1f71;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .required {
            color: #e74c3c;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .input-icon {
            position: relative;
        }

        .input-icon input {
            padding-left: 45px;
        }

        .input-icon::before {
            content: attr(data-icon);
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
        }

        /* DURATION SELECTOR */
        .duration-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 8px;
        }

        .duration-option {
            position: relative;
        }

        .duration-option input[type="radio"] {
            display: none;
        }

        .duration-label {
            display: block;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 600;
        }

        .duration-option input[type="radio"]:checked + .duration-label {
            background: #081c76;
            border-color: #112580;
            color: white;
        }

        .duration-label:hover {
            border-color: #667eea;
        }

        .custom-duration {
            display: none;
            margin-top: 15px;
        }

        .custom-duration.active {
            display: block;
        }

        /* INFO BANNER */
        .info-banner {
            background: #e8f4fd;
            border-left: 4px solid #1a1f71;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .info-banner p {
            font-size: 13px;
            color: #1a1f71;
            line-height: 1.5;
            margin: 0;
        }

        /* RIGHT SIDEBAR - SUMMARY */
        .booking-summary {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .summary-title {
            font-size: 20px;
            font-weight: 700;
            color: #1a1f71;
            margin-bottom: 20px;
        }

        .summary-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .summary-label {
            color: #666;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .summary-value {
            font-weight: 600;
            color: #333;
            text-align: right;
        }

        .summary-empty {
            color: #999;
            font-style: italic;
        }

        .price-breakdown {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .price-row.total {
            font-size: 18px;
            font-weight: 700;
            color: #1a1f71;
            padding-top: 15px;
            border-top: 2px solid #e0e0e0;
            margin-top: 10px;
        }

        .promo-section {
            margin-top: 20px;
        }

        .promo-input-group {
            display: flex;
            gap: 10px;
        }

        .promo-input-group input {
            flex: 1;
            padding: 12px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 13px;
        }

        .promo-btn {
            padding: 12px 20px;
            background: #1a1f71;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .promo-btn:hover {
            background: #2d42b9;
        }

        .continue-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #1a1f71 0%, #2d42b9 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 25px;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgb(17, 38, 132);
        }

        .continue-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(45, 66, 185, 0.4);
        }

        .continue-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* RESPONSIVE */
        @media (max-width: 968px) {
            .booking-container {
                grid-template-columns: 1fr;
            }

            .booking-summary {
                position: static;
            }
        }

        @media (max-width: 768px) {
            .booking-section,
            .booking-summary {
                padding: 25px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .duration-options {
                grid-template-columns: repeat(2, 1fr);
            }

            .location-card {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>
     <header>
        <div class="logo-section"> 
            <div class="logo">
                <div class="logo-icon">P</div>
                <div class="logo-text">
                    <h1>SMART PARKING</h1>
                    
                </div>
            </div>
        </div>
        <nav>
            <ul>
                <li><a href="./pages/find_parking.html" class="active">Home</a></li>
                <li><a href="./pages/booking_page.html">Booking</a></li>
                <li><a href="./pages/User_dashboard.html">Dashboard</a></li>
                <li><a href="./pages/help_page.html">Help</a></li>
                <li><a href="./pages/notification.html" class="notification_btn">Notifications<i class="fas fa-bell"></i></a></li>
            </ul>
        </nav>
       </div>
        <a href="./pages/profile_page.html">
    <div class="user-icon"></div>
</a>
    </header>
    <div class="booking-container">
        <!-- LEFT SECTION - BOOKING FORM -->
        <div class="booking-section">
            <a href="#" class="back-link" onclick="goBack()">‚Üê Back to Locations</a>
            
            <h1 class="section-title">Book Your Parking</h1>
            <p class="section-subtitle">Fill in the details below to reserve your spot</p>

            <!-- LOCATION INFO -->
            <div class="location-card">
                <div class="location-icon">üÖøÔ∏è</div>
                <div class="location-details">
                    <h3>Airport Parking</h3>
                    <p> Kigali International Airport, KN 8 Rd</p>
                    <span class="availability">‚úì 24 Spots Available</span>
                </div>
            </div>

            <!-- BOOKING FORM -->
            <form class="booking-form" id="bookingForm">
                <!-- DATE & TIME SECTION -->
                <div>
                    <h3 class="form-section-title"> When do you need parking?</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date <span class="required">*</span></label>
                            <input type="date" id="parkingDate" required min="">
                        </div>
                        <div class="form-group">
                            <label>Arrival Time <span class="required">*</span></label>
                            <input type="time" id="arrivalTime" required>
                        </div>
                    </div>
                </div>

                <!-- DURATION SECTION -->
                <div>
                    <h3 class="form-section-title"> How long will you park?</h3>
                    
                    <div class="duration-options">
                        <div class="duration-option">
                            <input type="radio" id="duration2" name="duration" value="2" onchange="selectDuration(2)">
                            <label for="duration2" class="duration-label">2 Hours</label>
                        </div>
                        <div class="duration-option">
                            <input type="radio" id="duration4" name="duration" value="4" onchange="selectDuration(4)">
                            <label for="duration4" class="duration-label">4 Hours</label>
                        </div>
                        <div class="duration-option">
                            <input type="radio" id="duration8" name="duration" value="8" onchange="selectDuration(8)">
                            <label for="duration8" class="duration-label">8 Hours</label>
                        </div>
                        <div class="duration-option">
                            <input type="radio" id="durationCustom" name="duration" value="custom" onchange="selectDuration('custom')">
                            <label for="durationCustom" class="duration-label">Custom</label>
                        </div>
                    </div>

                    <div class="custom-duration" id="customDurationDiv">
                        <div class="form-group">
                            <label>Number of Hours <span class="required">*</span></label>
                            <input type="number" id="customHours" min="1" max="168" placeholder="Enter hours (max 7 days)" oninput="updateCustomDuration()">
                        </div>
                    </div>
                </div>

                <!-- VEHICLE SECTION -->
                <div>
                    <h3 class="form-section-title"> Vehicle Information</h3>
                    
                    <div class="form-group">
                        <label>Vehicle Plate Number <span class="required">*</span></label>
                        <div class="input-icon" data-icon="">
                            <input type="text" id="vehiclePlate" placeholder="e.g., RAD 123A" required oninput="formatPlate(this)">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Vehicle Type <span class="required">*</span></label>
                            <select id="vehicleType" required onchange="updateSummary()">
                                <option value="">Select type</option>
                                <option value="sedan">Sedan</option>
                                <option value="suv">SUV</option>
                                <option value="truck">Truck</option>
                                <option value="motorcycle">Motorcycle</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Vehicle Color</label>
                            <input type="text" id="vehicleColor" placeholder="e.g., White">
                        </div>
                    </div>
                </div>

                <!-- CONTACT SECTION -->
                <div>
                    <h3 class="form-section-title">Contact Information</h3>
                    
                    <div class="form-group">
                        <label>Full Name <span class="required">*</span></label>
                        <input type="text" id="fullName" placeholder="Enter your full name" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Phone Number <span class="required">*</span></label>
                            <div class="input-icon" data-icon="">
                                <input type="tel" id="phoneNumber" placeholder="+250 7XX XXX XXX" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="email" placeholder="your@email.com">
                        </div>
                    </div>
                </div>

                <div class="info-banner">
                    <p>üí° <strong>Tip:</strong> Arrive within 30 minutes of your booked time. Late arrivals may result in spot reassignment.</p>
                </div>
            </form>
        </div>

        <!-- RIGHT SIDEBAR - BOOKING SUMMARY -->
        <div class="booking-summary">
            <h2 class="summary-title">Booking Summary</h2>

            <div class="summary-card">
                <div class="summary-row">
                    <span class="summary-label"> Location</span>
                    <span class="summary-value">Airport Parking</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label"> Date</span>
                    <span class="summary-value" id="summaryDate">-</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label"> Time</span>
                    <span class="summary-value" id="summaryTime">-</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label"> Duration</span>
                    <span class="summary-value" id="summaryDuration">-</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label"> Vehicle</span>
                    <span class="summary-value" id="summaryVehicle">-</span>
                </div>
            </div>

            <div class="price-breakdown">
                <div class="price-row">
                    <span>Parking Fee</span>
                    <span id="parkingFee">0 RWF</span>
                </div>
                <div class="price-row">
                    <span>Service Fee</span>
                    <span id="serviceFee">50 RWF</span>
                </div>
                <div class="price-row total">
                    <span>Total Amount</span>
                    <span id="totalAmount">50 RWF</span>
                </div>
            </div>

            <div class="promo-section">
                <div class="promo-input-group">
                    <input type="text" id="promoCode" placeholder="Enter promo code">
                    <button type="button" class="promo-btn" onclick="applyPromo()">Apply</button>
                </div>
            </div>

            <button class="continue-btn" onclick="proceedToPayment()" id="continueBtn" disabled>
                Continue to Payment
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="./assets/js/config.js"></script>
    <script>

        // Set minimum date to today
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('parkingDate').min = today;
            
            // Add change listeners
            document.getElementById('parkingDate').addEventListener('change', updateSummary);
            document.getElementById('arrivalTime').addEventListener('change', updateSummary);
            document.getElementById('vehiclePlate').addEventListener('input', updateSummary);
            document.getElementById('fullName').addEventListener('input', validateForm);
            document.getElementById('phoneNumber').addEventListener('input', validateForm);
        });

        let selectedDurationHours = 0;
        const HOURLY_RATE = 150; // RWF per hour

        function selectDuration(hours) {
            if (hours === 'custom') {
                document.getElementById('customDurationDiv').classList.add('active');
                selectedDurationHours = 0;
            } else {
                document.getElementById('customDurationDiv').classList.remove('active');
                document.getElementById('customHours').value = '';
                selectedDurationHours = hours;
            }
            updateSummary();
        }

        function updateCustomDuration() {
            const customHours = parseInt(document.getElementById('customHours').value) || 0;
            selectedDurationHours = customHours;
            updateSummary();
        }

        function formatPlate(input) {
            input.value = input.value.toUpperCase();
            updateSummary();
        }

        function updateSummary() {
            // Update date
            const date = document.getElementById('parkingDate').value;
            if (date) {
                const dateObj = new Date(date);
                const formatted = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                document.getElementById('summaryDate').textContent = formatted;
            } else {
                document.getElementById('summaryDate').textContent = '-';
            }


            // Update time
            const time = document.getElementById('arrivalTime').value;
            if (time) {
                const [hours, minutes] = time.split(':');
                const timeObj = new Date();
                timeObj.setHours(hours, minutes);
                const formatted = timeObj.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                document.getElementById('summaryTime').textContent = formatted;
            } else {
                document.getElementById('summaryTime').textContent = '-';
            }

            // Update duration
            if (selectedDurationHours > 0) {
                const durationText = selectedDurationHours === 1 ? '1 Hour' : `${selectedDurationHours} Hours`;
                document.getElementById('summaryDuration').textContent = durationText;
            } else {
                document.getElementById('summaryDuration').textContent = '-';
            }

            // Update vehicle
            const plate = document.getElementById('vehiclePlate').value;
            if (plate) {
                document.getElementById('summaryVehicle').textContent = plate;
            } else {
                document.getElementById('summaryVehicle').textContent = '-';
            }

            // Update pricing
            const parkingFee = selectedDurationHours * HOURLY_RATE;
            const serviceFee = 50;
            const total = parkingFee + serviceFee;

            document.getElementById('parkingFee').textContent = `${parkingFee} RWF`;
            document.getElementById('totalAmount').textContent = `${total} RWF`;

            // Validate form
            validateForm();
        }

        function validateForm() {
            const date = document.getElementById('parkingDate').value;
            const time = document.getElementById('arrivalTime').value;
            const duration = selectedDurationHours > 0;
            const plate = document.getElementById('vehiclePlate').value.trim();
            const vehicleType = document.getElementById('vehicleType').value;
            const name = document.getElementById('fullName').value.trim();
            const phone = document.getElementById('phoneNumber').value.trim();

            const isValid = date && time && duration && plate && vehicleType && name && phone;
            
            document.getElementById('continueBtn').disabled = !isValid;
        }

        function applyPromo() {
            const promoCode = document.getElementById('promoCode').value.toUpperCase().trim();
            
            if (!promoCode) {
                alert('Please enter a promo code');
                return;
            }

            // Demo promo codes
            const promoCodes = {
                'SAVE10': 0.10,
                'FIRST20': 0.20,
                'AIRPORT15': 0.15
            };

            if (promoCodes[promoCode]) {
                const discount = promoCodes[promoCode];
                alert(`‚úì Promo code "${promoCode}" applied! You saved ${discount * 100}%`);
                // In real app, update pricing here
            } else {
                alert('Invalid promo code. Try: SAVE10, FIRST20, or AIRPORT15');
            }
        }

        async function proceedToPayment() {
    // Check driver_id
    const driverId = localStorage.getItem("driver_id");
    if (!driverId) {
        alert("You are not logged in or driver ID is missing!");
        return;
    }

    // Check duration
    if (selectedDurationHours <= 0) {
        alert("Please select a valid duration.");
        return;
    }

    // Parse date and time
    const date = document.getElementById("parkingDate").value;
    const time = document.getElementById("arrivalTime").value;

    if (!date || !time) {
        alert("Please select a valid date and time.");
        return;
    }

    const startTimeStr = `${date} ${time}:00`;
    const startTime = new Date(startTimeStr);
    const endTime = new Date(startTime.getTime() + selectedDurationHours * 60 * 60 * 1000);

    const totalPrice = selectedDurationHours * HOURLY_RATE + 50;

    // Build booking payload
    const bookingPayload = {
        driver_id: parseInt(driverId),
        spot_id: 1, // you can dynamically choose the spot later
        start_time: startTime.toISOString().slice(0, 19).replace("T", " "),
        end_time: endTime.toISOString().slice(0, 19).replace("T", " "),
        total_price: totalPrice
    };

    console.log("Booking payload:", bookingPayload); // for debugging

    try {
        // POST request with proper JSON header
        const response = await axios.post(
            `${API_BASE_URL}/reservation/book`,
            bookingPayload,
            { headers: { "Content-Type": "application/json" } }
        );

        if (!response.data.success) {
            alert(response.data.message || "Reservation failed");
            return;
        }

        // Save reservation ID for payment
        localStorage.setItem("current_reservation_id", response.data.reservation_id);

        // Save full booking info for payment page
        const bookingInfo = {
            ...bookingPayload,
            vehiclePlate: document.getElementById("vehiclePlate").value,
            vehicleType: document.getElementById("vehicleType").value,
            vehicleColor: document.getElementById("vehicleColor").value,
            fullName: document.getElementById("fullName").value,
            phoneNumber: document.getElementById("phoneNumber").value,
            email: document.getElementById("email").value
        };
        localStorage.setItem("currentBooking", JSON.stringify(bookingInfo));

        alert("Reservation created! Redirecting to payment page...");
        window.location.href = "./pages/payment_page.html";

    } catch (error) {
        console.error("Reservation error:", error.response || error);
        const msg = error.response?.data?.message || "Failed to create reservation. Please check your connection.";
        alert(msg);
    }
}


        function goBack() {
            if (confirm('Are you sure you want to go back? Your booking information will not be saved.')) {
                window.history.back();
            }
        }
    </script>
</body>
</html>